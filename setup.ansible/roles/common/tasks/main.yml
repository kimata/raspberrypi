- name: Install Packages
  apt:
    pkg={{ item }}
    state=present
  with_items:
    - powertop
    - lsb-release
    - ntp
    - ntpdate
    - i2c-tools
    - python-smbus

- name: Generate Locales
  locale_gen:
    name: "{{ item }}"
    state: present
  with_items:
    - en_US.UTF-8
    - ja_JP.UTF-8

- name: Setting Network - interfaces
  replace: >-
    dest='/etc/network/interfaces'
    regexp='{{ item.regexp }}'
    replace='{{ item.replace }}'
  with_items:
    - regexp: '^iface eth0 inet manual$'
      replace: 'iface eth0 inet dhcp'
    - regexp: '^iface wlan0 inet manual$'
      replace: 'iface wlan0 inet dhcp'

- name: Setting Sudo
  template:
    src=sudo/sudoers.j2 dest=/etc/sudoers
    owner=root
    group=root
    mode=0440

- name: Setting SSHD
  template:
    src=ssh/sshd_config.j2 dest=/etc/ssh/sshd_config
  notify:
    restart sshd

- name: Setting NTPD client
  template:
    src=ntp/ntp.conf.j2 dest=/etc/ntp.conf
    owner=ntp
    group=ntp
  notify:
    restart ntp

- name: Setting ntpdate
  lineinfile: >-
    dest='/etc/rc.local'
    state=present
    insertbefore='exit 0'
    line='ntpdate -bu ntp.nict.jp'

- name: Setting powertop
  lineinfile: >-
    dest='/etc/rc.local'
    state=present
    insertbefore='exit 0'
    line='powertop --auto-tune'

- name: Setting USB off
  lineinfile: >-
    dest='/etc/rc.local'
    state=present
    insertbefore='exit 0'
    line='echo 0 > /sys/devices/platform/soc/3f980000.usb/buspower'

- name: Setting HDMI off
  lineinfile: >-
    dest='/etc/rc.local'
    state=present
    insertbefore='exit 0'
    line='/opt/vc/bin/tvservice --off'
    
- name: Setting WiFi - WiFi config existence
  local_action: stat path=wifi_config.yml
  register: wifi_config_file

- name: Setting WiFi - WiFi existence
  stat: path=/sys/class/net/wlan0
  when: wifi_config_file.stat.exists
  register: wifi

- name: Setting WiFi - wpa_supplicant
  when: wifi is defined and wifi.stat.exists 
  template:
    src=wifi/wpa_supplicant.conf.j2 dest=/etc/wpa_supplicant/wpa_supplicant.conf
    owner=root
    group=root
    mode=600

- name: Setting Wifi - interfaces
  when: wifi is defined and wifi.stat.exists 
  lineinfile: >-
    dest='/etc/network/interfaces'
    state=present
    insertbefore='allow-hotplug wlan0'
    line='auto wlan0'

- name: Setting Wifi - dhcp
  when: wifi is defined and wifi.stat.exists 
  # NOTE: Wifi の場合は「ホスト名-wifi」でアクセスできるようにする
  lineinfile: >-
    dest='/etc/dhcp/dhclient.conf'
    state=present
    line='interface "wlan0" { send host-name = concat (gethostname(), "-wifi"); }'

- name: Enable I2C at 50kHz
  lineinfile: >-
    dest='/boot/config.txt'
    state=present
    line='{{ item }}'
  with_items:
    - dtparam=i2c_arm=on
    - dtparam=i2c_baudrate=50000

- name: Load I2C module
  lineinfile: >-
    dest='/etc/modules'
    state=present
    line='i2c-dev'

# Local Variables:
# mode: yaml
# tab-width: 4
# End:
